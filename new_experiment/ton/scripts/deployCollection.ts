import fs from "fs";
import { toNano, beginCell, Cell, Address, contractAddress } from "@ton/core";
import { NetworkProvider } from "@ton/blueprint";

// Deploy collection generated by TACT.
// Run: npx blueprint run deployCollection --testnet
export async function run(provider: NetworkProvider) {
  const sender = provider.sender();

  // Load NFT item code from compiled BOC
  const nftItemCodeBoc = fs.readFileSync("contracts/NftItem.tact_NftItem.code.boc");
  const nftItemCode = Cell.fromBoc(nftItemCodeBoc)[0];

  const collectionCode = Cell.fromBoc(fs.readFileSync("contracts/NftCollection.tact_NftCollection.code.boc"))[0];

  // Simple collection content (replace with real base URI if needed)
  const collectionContent = beginCell().storeStringTail("https://example.com/nft/").endCell();

  // Build data cell: owner, next_item_index=0, content, item_code
  const data = beginCell()
    .storeAddress(sender.address as Address)
    .storeUint(0, 64)
    .storeRef(collectionContent)
    .storeRef(nftItemCode)
    .endCell();

  const init = { code: collectionCode, data };
  const address = contractAddress(0, init);

  if (await provider.isContractDeployed(address)) {
    console.log(`Collection already deployed at ${address.toString()}`);
    return;
  }

  await sender.send({
    to: address,
    value: toNano("0.05"),
    init,
    body: beginCell().endCell(),
  });

  console.log("Collection deployed at:");
  console.log(address.toString());
}
